{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 82, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/lib/supabaseAdmin.ts"],"sourcesContent":["import { createClient, type SupabaseClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\nexport function getSupabaseAdmin(): SupabaseClient {\n  if (!supabaseUrl || !serviceRoleKey) {\n    throw new Error('Missing Supabase admin env. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY (server-only).')\n  }\n  \n  return createClient(supabaseUrl as string, serviceRoleKey as string, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n\n\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;AAErD,SAAS;IACd,IAAI,CAAC,eAAe,CAAC,gBAAgB;QACnC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,mRAAY,EAAC,aAAuB,gBAA0B;QACnE,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 105, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/app/api/admin/attendance-reports/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport { getSupabaseAdmin } from '@/lib/supabaseAdmin'\n\nexport async function GET(request: Request) {\n  try {\n    console.log('üìä Attendance Reports API called')\n    const { searchParams } = new URL(request.url)\n    const startDate = searchParams.get('startDate') // Optional: filter by start date\n    const endDate = searchParams.get('endDate') // Optional: filter by end date\n    const studentId = searchParams.get('studentId') // Optional: filter by specific student\n    const gradeLevel = searchParams.get('gradeLevel') // Optional: filter by grade\n    const section = searchParams.get('section') // Optional: filter by section\n    \n    console.log('üìÖ Date range:', { startDate, endDate, studentId, gradeLevel, section })\n    \n    const admin = getSupabaseAdmin()\n    \n    // Calculate date range (default: last 30 days)\n    const end = endDate ? new Date(endDate) : new Date()\n    const start = startDate ? new Date(startDate) : new Date()\n    if (!startDate) {\n      start.setDate(start.getDate() - 30) // Default to 30 days ago\n    }\n    \n    const startISO = start.toISOString()\n    const endISO = end.toISOString()\n    \n    console.log('üîç Querying students...')\n    // Fetch all students\n    const { data: students, error: studentsError } = await admin\n      .from('students')\n      .select('*')\n      .limit(1000)\n    \n    if (studentsError) {\n      console.error('‚ùå Error fetching students:', studentsError)\n      return NextResponse.json(\n        {\n          success: false,\n          error: `Failed to fetch students: ${studentsError.message}`,\n          data: null,\n        },\n        { status: 200 }\n      )\n    }\n    \n    console.log(`‚úÖ Found ${students?.length || 0} students`)\n    \n    // Filter students by grade/section if specified\n    let filteredStudents = students || []\n    if (gradeLevel && gradeLevel !== 'all') {\n      filteredStudents = filteredStudents.filter((s: any) => \n        (s.grade_level || '').toString().toLowerCase() === gradeLevel.toLowerCase()\n      )\n    }\n    if (section && section !== 'all') {\n      filteredStudents = filteredStudents.filter((s: any) => \n        (s.section || '').toString().toLowerCase() === section.toLowerCase()\n      )\n    }\n    \n    console.log('üîç Querying attendance records from', startISO, 'to', endISO)\n    // Fetch attendance records\n    const { data: allAttendanceRecords, error: attendanceError } = await admin\n      .from('attendance_records')\n      .select('*')\n      .gte('scan_time', startISO)\n      .lte('scan_time', endISO)\n      .order('scan_time', { ascending: true })\n    \n    if (attendanceError) {\n      console.error('‚ùå Error fetching attendance records:', attendanceError)\n      return NextResponse.json(\n        {\n          success: false,\n          error: `Failed to fetch attendance records: ${attendanceError.message}`,\n          data: null,\n        },\n        { status: 200 }\n      )\n    }\n    \n    console.log(`‚úÖ Found ${allAttendanceRecords?.length || 0} attendance records`)\n    \n    // Build student map for quick lookup\n    const studentMap: Record<string, any> = {}\n    if (students) {\n      students.forEach((student: any) => {\n        const studentIdStr = (student.student_id || student.student_number || student.id || '').toString().trim()\n        if (studentIdStr) {\n          studentMap[studentIdStr] = {\n            ...student,\n            fullName: `${student.first_name || student.firstName || ''} ${student.last_name || student.lastName || ''}`.trim() || student.name || 'Unknown',\n          }\n        }\n      })\n    }\n    \n    // Filter attendance records to only include students (not teachers)\n    const studentAttendanceRecords = (allAttendanceRecords || []).filter((record: any) => {\n      const recordId = (record.student_id || '').toString().trim()\n      const student = studentMap[recordId]\n      return student !== undefined\n    })\n    \n    // Filter by specific student if requested\n    let finalRecords = studentAttendanceRecords\n    if (studentId && studentId !== 'all') {\n      finalRecords = studentAttendanceRecords.filter((record: any) => {\n        const recordId = (record.student_id || '').toString().trim()\n        return recordId === studentId.toString().trim()\n      })\n    }\n    \n    // Group attendance by student\n    const studentStats: Record<string, {\n      student: any\n      records: any[]\n      totalDays: number\n      present: number\n      absent: number\n      late: number\n      excused: number\n      percentage: number\n      dailyAttendance: Record<string, string> // date -> status code\n    }> = {}\n    \n    // Process each attendance record\n    finalRecords.forEach((record: any) => {\n      const recordId = (record.student_id || '').toString().trim()\n      const student = studentMap[recordId]\n      \n      if (!student) return\n      \n      const studentKey = student.student_id || student.student_number || recordId\n      \n      if (!studentStats[studentKey]) {\n        studentStats[studentKey] = {\n          student,\n          records: [],\n          totalDays: 0,\n          present: 0,\n          absent: 0,\n          late: 0,\n          excused: 0,\n          percentage: 0,\n          dailyAttendance: {},\n        }\n      }\n      \n      studentStats[studentKey].records.push(record)\n      \n      // Determine status\n      const scanDate = new Date(record.scan_time).toISOString().split('T')[0] // YYYY-MM-DD\n      const status = (record.status || 'Present').toLowerCase()\n      const scanType = (record.scan_type || 'timein').toLowerCase()\n      \n      // Count attendance (only count time-in records to avoid double counting)\n      if (scanType === 'timein' || scanType === 'time_in') {\n        if (status === 'present') {\n          studentStats[studentKey].present++\n          studentStats[studentKey].dailyAttendance[scanDate] = 'PR' // Present\n        } else if (status === 'absent') {\n          studentStats[studentKey].absent++\n          studentStats[studentKey].dailyAttendance[scanDate] = 'AC' // Absent - Coded\n        } else if (status === 'late') {\n          studentStats[studentKey].late++\n          studentStats[studentKey].dailyAttendance[scanDate] = 'LA' // Late\n        } else if (status === 'excused') {\n          studentStats[studentKey].excused++\n          studentStats[studentKey].dailyAttendance[scanDate] = 'EX' // Excused\n        }\n        studentStats[studentKey].totalDays++\n      }\n    })\n    \n    // Calculate percentages and format data\n    const studentList = Object.values(studentStats).map((stats) => {\n      const total = stats.totalDays || 1 // Avoid division by zero\n      stats.percentage = Math.round((stats.present / total) * 100)\n      \n      return {\n        studentId: stats.student.student_id || stats.student.student_number || stats.student.id,\n        studentName: stats.student.fullName,\n        gradeLevel: stats.student.grade_level || stats.student.gradeLevel || 'N/A',\n        section: stats.student.section || 'N/A',\n        totalDays: stats.totalDays,\n        present: stats.present,\n        absent: stats.absent,\n        late: stats.late,\n        excused: stats.excused,\n        percentage: stats.percentage,\n        dailyAttendance: stats.dailyAttendance,\n        records: stats.records,\n      }\n    })\n    \n    // Calculate general statistics\n    const totalStudents = studentList.length || 1\n    const totalPresent = studentList.reduce((sum, s) => sum + s.present, 0)\n    const totalAbsent = studentList.reduce((sum, s) => sum + s.absent, 0)\n    const totalLate = studentList.reduce((sum, s) => sum + s.late, 0)\n    const totalDays = studentList.reduce((sum, s) => sum + s.totalDays, 0)\n    const overallPresentPercentage = totalDays > 0 ? Math.round((totalPresent / totalDays) * 100) : 0\n    const overallAbsentPercentage = totalDays > 0 ? Math.round((totalAbsent / totalDays) * 100) : 0\n    \n    // Filter by specific student if requested\n    let selectedStudentData = null\n    if (studentId && studentId !== 'all') {\n      selectedStudentData = studentList.find((s) => \n        (s.studentId || '').toString() === studentId.toString()\n      )\n    }\n    \n    // Get unique grade levels and sections for filters\n    const gradeLevels = [...new Set((students || []).map((s: any) => s.grade_level || s.gradeLevel).filter(Boolean))]\n    const sections = [...new Set((students || []).map((s: any) => s.section).filter(Boolean))]\n    \n    console.log(`üìà Returning data: ${studentList.length} students, ${totalDays} total days, ${overallPresentPercentage}% present`)\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        general: {\n          totalStudents,\n          totalPresent,\n          totalAbsent,\n          totalLate,\n          totalDays,\n          presentPercentage: overallPresentPercentage,\n          absentPercentage: overallAbsentPercentage,\n        },\n        students: studentList,\n        selectedStudent: selectedStudentData,\n        dateRange: {\n          start: startISO,\n          end: endISO,\n        },\n        filters: {\n          gradeLevels: gradeLevels.sort(),\n          sections: sections.sort(),\n        },\n      },\n    }, { status: 200 })\n  } catch (error: any) {\n    console.error('Error in attendance reports API:', error)\n    return NextResponse.json(\n      {\n        success: false,\n        error: error?.message || 'Internal server error',\n        data: null,\n      },\n      { status: 200 }\n    )\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}