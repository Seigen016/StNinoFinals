{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/lib/supabaseAdmin.ts"],"sourcesContent":["import { Database } from '@/database.types'\nimport { createClient, type SupabaseClient } from '@supabase/supabase-js'\n\n/**\n * Supabase Admin Client for Server-Side Operations\n * \n * ⚠️ SECURITY WARNING: This client uses the SERVICE ROLE KEY\n * - Bypasses ALL Row Level Security (RLS) policies\n * - Full database access with no restrictions\n * - ONLY use in server-side code (API routes, Server Components)\n * - NEVER import or use in client-side components\n * \n * Use Cases:\n * - Admin operations requiring elevated privileges\n * - System-level database operations\n * - Background jobs and cron tasks\n */\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n/**\n * Creates and returns a Supabase admin client instance\n * \n * @returns SupabaseClient with full admin privileges\n * @throws Error if environment variables are not set\n * \n * @example\n * ```ts\n * // In API route or Server Component only\n * const supabaseAdmin = getSupabaseAdmin();\n * const { data } = await supabaseAdmin.from('users').select('*');\n * ```\n */\nexport function getSupabaseAdmin(): SupabaseClient {\n  if (!supabaseUrl || !serviceRoleKey) {\n    throw new Error('Missing Supabase admin env. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY (server-only).')\n  }\n  \n  return createClient<Database>(supabaseUrl as string, serviceRoleKey as string, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n\n\n"],"names":[],"mappings":";;;;AACA;;AAEA;;;;;;;;;;;;;CAaC,GAED,MAAM;AACN,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;AAerD,SAAS;IACd,IAAI,CAAC,eAAe,CAAC,gBAAgB;QACnC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,mRAAY,EAAW,aAAuB,gBAA0B;QAC7E,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/app/api/teacher/grades/route.ts"],"sourcesContent":["import { getSupabaseAdmin } from '@/lib/supabaseAdmin'\nimport { NextRequest, NextResponse } from 'next/server'\n\nexport async function GET(request: NextRequest) {\n  try {\n    const admin = getSupabaseAdmin()\n    const { searchParams } = new URL(request.url)\n    const teacherId = searchParams.get('teacherId')\n    const section = searchParams.get('section')\n    const quarter = searchParams.get('quarter')\n    const subject = searchParams.get('subject')\n\n    if (!teacherId) {\n      return NextResponse.json(\n        { success: false, error: 'Teacher ID is required' },\n        { status: 400 }\n      )\n    }\n\n    // Get teacher's classes\n    let classesQuery = admin\n      .from('classes')\n      .select('id, class_name, section, grade_level')\n      .eq('teacher_id', teacherId)\n      .eq('is_active', true)\n\n    if (section) {\n      classesQuery = classesQuery.eq('section', section)\n    }\n\n    const { data: classes, error: classesError } = await classesQuery\n\n    if (classesError) {\n      console.error('Error fetching classes:', classesError)\n      return NextResponse.json(\n        { success: false, error: 'Failed to fetch classes' },\n        { status: 500 }\n      )\n    }\n\n    if (!classes || classes.length === 0) {\n      return NextResponse.json({\n        success: true,\n        data: []\n      })\n    }\n\n    // Get students in these classes\n    const classIds = classes.map(c => c.id)\n    const { data: enrollments, error: enrollmentsError } = await admin\n      .from('class_enrollments')\n      .select('student_id, class_id')\n      .in('class_id', classIds)\n      .eq('status', 'active')\n\n    if (enrollmentsError) {\n      console.error('Error fetching enrollments:', enrollmentsError)\n      return NextResponse.json(\n        { success: false, error: 'Failed to fetch enrollments' },\n        { status: 500 }\n      )\n    }\n\n    if (!enrollments || enrollments.length === 0) {\n      return NextResponse.json({\n        success: true,\n        data: []\n      })\n    }\n\n    const studentIds = [...new Set(enrollments.map(e => e.student_id))]\n    const { data: students, error: studentsError } = await admin\n      .from('users')\n      .select('id, first_name, last_name, student_number')\n      .in('id', studentIds)\n      .eq('role', 'student')\n\n    if (studentsError) {\n      console.error('Error fetching students:', studentsError)\n      return NextResponse.json(\n        { success: false, error: 'Failed to fetch students' },\n        { status: 500 }\n      )\n    }\n\n    // Get existing grades for these students\n    let gradesQuery = admin\n      .from('grades')\n      .select('*')\n      .in('student_id', studentIds)\n\n    if (subject) {\n      gradesQuery = gradesQuery.eq('subject', subject)\n    }\n\n    const { data: existingGrades, error: gradesError } = await gradesQuery\n\n    if (gradesError) {\n      console.error('Error fetching grades:', gradesError)\n      // Continue without grades rather than failing\n    }\n\n    // Format data for grades management\n    const gradesData = students?.map(student => {\n      const studentGrades = existingGrades?.filter(g => g.student_id === student.id) || []\n      \n      return {\n        id: student.id,\n        name: `${student.first_name} ${student.last_name}`,\n        studentNumber: student.student_number,\n        writtenWork: Array(5).fill(''), // Initialize empty\n        performanceTasks: Array(5).fill(''),\n        quarterlyAssessment: '',\n        existingGrades: studentGrades // Include for reference\n      }\n    }) || []\n\n    return NextResponse.json({\n      success: true,\n      data: gradesData\n    })\n  } catch (error: any) {\n    console.error('Teacher grades API error:', error)\n    return NextResponse.json(\n      {\n        success: false,\n        error: error?.message || 'Internal server error'\n      },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const admin = getSupabaseAdmin()\n    const body = await request.json()\n    const { teacherId, subject, section, quarter, grades } = body\n\n    if (!teacherId || !subject || !grades) {\n      return NextResponse.json(\n        { success: false, error: 'Missing required fields' },\n        { status: 400 }\n      )\n    }\n\n    // Save grades to database\n    const gradeRecords = []\n    for (const studentGrade of grades) {\n      // Calculate final grade based on the weighted components\n      const writtenWorkScores = studentGrade.writtenWork\n        .map((score: string) => parseFloat(score) || 0)\n        .filter((score: number) => score > 0)\n      const writtenWorkAvg = writtenWorkScores.length > 0\n        ? writtenWorkScores.reduce((a: number, b: number) => a + b, 0) / writtenWorkScores.length\n        : 0\n\n      const performanceScores = studentGrade.performanceTasks\n        .map((score: string) => parseFloat(score) || 0)\n        .filter((score: number) => score > 0)\n      const performanceAvg = performanceScores.length > 0\n        ? performanceScores.reduce((a: number, b: number) => a + b, 0) / performanceScores.length\n        : 0\n\n      const quarterlyScore = parseFloat(studentGrade.quarterlyAssessment) || 0\n\n      // Use the same weights as the UI\n      const weights = getGradingWeights(subject)\n      const finalGrade =\n        (writtenWorkAvg * weights.writtenWork) / 100 +\n        (performanceAvg * weights.performanceTasks) / 100 +\n        (quarterlyScore * weights.quarterlyAssessment) / 100\n\n      if (finalGrade > 0) {\n        gradeRecords.push({\n          student_id: studentGrade.id,\n          subject: subject,\n          grade: finalGrade,\n          // You might want to store additional metadata like quarter, components, etc.\n        })\n      }\n    }\n\n    if (gradeRecords.length > 0) {\n      const { error: insertError } = await admin\n        .from('grades')\n        .upsert(gradeRecords, { onConflict: 'student_id,subject' })\n\n      if (insertError) {\n        console.error('Error saving grades:', insertError)\n        return NextResponse.json(\n          { success: false, error: 'Failed to save grades' },\n          { status: 500 }\n        )\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: 'Grades saved successfully'\n    })\n  } catch (error: any) {\n    console.error('Save grades API error:', error)\n    return NextResponse.json(\n      {\n        success: false,\n        error: error?.message || 'Internal server error'\n      },\n      { status: 500 }\n    )\n  }\n}\n\n// Helper function to get grading weights\nfunction getGradingWeights(subject: string) {\n  const subjectLower = subject?.toLowerCase() || ''\n  \n  if (\n    subjectLower.includes('filipino') ||\n    subjectLower.includes('english') ||\n    subjectLower.includes('araling panlipunan') ||\n    subjectLower.includes('ap') ||\n    subjectLower.includes('esp') ||\n    subjectLower.includes('edukasyon sa pagpapakatao') ||\n    subjectLower.includes('mother tongue') ||\n    subjectLower.includes('mt')\n  ) {\n    return { writtenWork: 30, performanceTasks: 50, quarterlyAssessment: 20 }\n  }\n  \n  if (\n    subjectLower.includes('science') ||\n    subjectLower.includes('mathematics') ||\n    subjectLower.includes('math')\n  ) {\n    return { writtenWork: 40, performanceTasks: 40, quarterlyAssessment: 20 }\n  }\n  \n  if (\n    subjectLower.includes('mapeh') ||\n    subjectLower.includes('music') ||\n    subjectLower.includes('arts') ||\n    subjectLower.includes('physical education') ||\n    subjectLower.includes('health') ||\n    subjectLower.includes('epp') ||\n    subjectLower.includes('tle') ||\n    subjectLower.includes('technology') ||\n    subjectLower.includes('livelihood') ||\n    subjectLower.includes('elective') ||\n    subjectLower.includes('writing')\n  ) {\n    return { writtenWork: 20, performanceTasks: 60, quarterlyAssessment: 20 }\n  }\n  \n  return { writtenWork: 30, performanceTasks: 50, quarterlyAssessment: 20 }\n}\n"],"names":[],"mappings":"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"}}]
}