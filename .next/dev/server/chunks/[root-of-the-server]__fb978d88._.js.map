{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/lib/supabaseAdmin.ts"],"sourcesContent":["import { Database } from '@/database.types'\nimport { createClient, type SupabaseClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\nexport function getSupabaseAdmin(): SupabaseClient {\n  if (!supabaseUrl || !serviceRoleKey) {\n    throw new Error('Missing Supabase admin env. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY (server-only).')\n  }\n  \n  return createClient<Database>(supabaseUrl as string, serviceRoleKey as string, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n\n\n"],"names":[],"mappings":";;;;AACA;;AAEA,MAAM;AACN,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;AAErD,SAAS;IACd,IAAI,CAAC,eAAe,CAAC,gBAAgB;QACnC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,mRAAY,EAAW,aAAuB,gBAA0B;QAC7E,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 105, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/app/api/admin/teacher-attendance/route.ts"],"sourcesContent":["import { getSupabaseAdmin } from '@/lib/supabaseAdmin'\nimport { NextResponse } from 'next/server'\n\nexport async function GET(request: Request) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const startDate = searchParams.get('startDate') // Optional: filter by start date\n    const endDateParam = searchParams.get('endDate') // Optional: filter by end date\n    const teacherId = searchParams.get('teacherId') // Optional: filter by specific teacher\n    \n    const admin = getSupabaseAdmin()\n    \n    // Calculate date range (default: last 30 days) - Manila timezone\n    const startDateStr = startDate || (() => {\n      const d = new Date()\n      d.setDate(d.getDate() - 30)\n      return d.toISOString().split('T')[0]\n    })()\n    const endDateStr = endDateParam || new Date().toISOString().split('T')[0]\n    \n    // Convert Manila local date to UTC range\n    const startISO = `${startDateStr}T00:00:00.000Z`\n    const endISO = `${endDateStr}T23:59:59.999Z`\n    \n    // Fetch all teachers\n    const { data: teachers, error: teachersError } = await admin\n      .from('teachers')\n      .select('*')\n      .limit(1000)\n    \n    if (teachersError) {\n      console.error('Error fetching teachers:', teachersError)\n    }\n    \n    // Fetch attendance records for teachers\n    // Teachers are identified by checking if student_id matches a teacher_id or email\n    const { data: allAttendanceRecords, error: attendanceError } = await admin\n      .from('attendance_records')\n      .select('*')\n      .gte('scan_time', startISO)\n      .lte('scan_time', endISO)\n      .order('scan_time', { ascending: true })\n    \n    if (attendanceError) {\n      console.error('Error fetching attendance records:', attendanceError)\n      return NextResponse.json(\n        {\n          success: false,\n          error: attendanceError.message,\n          data: null,\n        },\n        { status: 200 }\n      )\n    }\n    \n    // Build teacher map for quick lookup by ID, email, and RFID\n    const teacherMap: Record<string, any> = {}\n    const teacherRfidMap: Record<string, any> = {} // Map RFID to teacher\n    if (teachers) {\n      teachers.forEach((teacher: any) => {\n        const teacherIdStr = (teacher.teacher_id || teacher.id || '').toString().trim()\n        const teacherEmail = (teacher.email || '').toString().trim().toLowerCase()\n        const teacherName = `${teacher.first_name || ''} ${teacher.last_name || ''}`.trim() || teacher.name || 'Unknown'\n        \n        // Map by teacher ID\n        if (teacherIdStr) {\n          teacherMap[teacherIdStr] = {\n            ...teacher,\n            fullName: teacherName,\n          }\n        }\n        \n        // Map by email\n        if (teacherEmail) {\n          teacherMap[teacherEmail] = {\n            ...teacher,\n            fullName: teacherName,\n          }\n        }\n        \n        // Map by RFID card (normalize: uppercase, remove spaces)\n        const rfidCard = (teacher.rfid_card || teacher.rfidCard || teacher.rfid_tag || teacher.rfidTag || '').toString().trim().toUpperCase().replace(/\\s+/g, '')\n        if (rfidCard) {\n          teacherRfidMap[rfidCard] = {\n            ...teacher,\n            fullName: teacherName,\n          }\n          // Also add to main map for quick lookup\n          teacherMap[rfidCard] = {\n            ...teacher,\n            fullName: teacherName,\n          }\n        }\n      })\n    }\n    \n    console.log(`ðŸ“Š Found ${teachers?.length || 0} teachers`)\n    console.log(`ðŸ”‘ Teacher RFID map has ${Object.keys(teacherRfidMap).length} entries:`, Object.keys(teacherRfidMap))\n    \n    // Filter attendance records to only include teachers\n    // Check both student_id match AND RFID card match\n    const teacherAttendanceRecords = (allAttendanceRecords || []).filter((record: any) => {\n      const recordId = (record.student_id || '').toString().trim()\n      const recordRfid = (record.rfid_card || record.rfidCard || record.rfid_tag || record.rfidTag || '').toString().trim().toUpperCase().replace(/\\s+/g, '')\n      \n      // Check if student_id matches a teacher\n      if (teacherMap[recordId] !== undefined) {\n        return true\n      }\n      \n      // Check if RFID card matches a teacher\n      if (recordRfid && teacherRfidMap[recordRfid] !== undefined) {\n        return true\n      }\n      \n      return false\n    })\n    \n    console.log(`âœ… Found ${teacherAttendanceRecords.length} teacher attendance records out of ${allAttendanceRecords?.length || 0} total records`)\n    \n    // Group attendance by teacher\n    const teacherStats: Record<string, {\n      teacher: any\n      records: any[]\n      totalDays: number\n      present: number\n      absent: number\n      late: number\n      percentage: number\n      dailyAttendance: Record<string, string> // date -> status code\n    }> = {}\n    \n    // Process each attendance record\n    teacherAttendanceRecords.forEach((record: any) => {\n      const recordId = (record.student_id || '').toString().trim()\n      const recordRfid = (record.rfid_card || record.rfidCard || record.rfid_tag || record.rfidTag || '').toString().trim().toUpperCase().replace(/\\s+/g, '')\n      \n      // Try to find teacher by student_id first, then by RFID\n      let teacher = teacherMap[recordId]\n      if (!teacher && recordRfid) {\n        teacher = teacherRfidMap[recordRfid] || teacherMap[recordRfid]\n      }\n      \n      if (!teacher) {\n        console.log(`âš ï¸ Could not find teacher for record: student_id=${recordId}, rfid=${recordRfid}`)\n        return\n      }\n      \n      const teacherKey = teacher.teacher_id || teacher.id || recordId\n      \n      if (!teacherStats[teacherKey]) {\n        teacherStats[teacherKey] = {\n          teacher,\n          records: [],\n          totalDays: 0,\n          present: 0,\n          absent: 0,\n          late: 0,\n          percentage: 0,\n          dailyAttendance: {},\n        }\n      }\n      \n      teacherStats[teacherKey].records.push(record)\n      \n      // Determine status - Use Manila timezone to get correct date\n      const scanDateTime = new Date(record.scan_time)\n      const manilaDate = new Date(scanDateTime.toLocaleString('en-US', { timeZone: 'Asia/Manila' }))\n      const year = manilaDate.getFullYear()\n      const month = String(manilaDate.getMonth() + 1).padStart(2, '0')\n      const day = String(manilaDate.getDate()).padStart(2, '0')\n      const scanDate = `${year}-${month}-${day}` // YYYY-MM-DD in Manila time\n      const status = record.status || 'Present'\n      const scanType = record.scan_type || 'timein'\n      \n      // Count attendance\n      if (status === 'Present' || scanType === 'timein') {\n        teacherStats[teacherKey].present++\n        teacherStats[teacherKey].dailyAttendance[scanDate] = 'PR' // Present\n      } else if (status === 'Absent') {\n        teacherStats[teacherKey].absent++\n        teacherStats[teacherKey].dailyAttendance[scanDate] = 'AC' // Absent - Coded\n      } else if (status === 'Late') {\n        teacherStats[teacherKey].late++\n        teacherStats[teacherKey].dailyAttendance[scanDate] = 'LA' // Late\n      }\n      \n      teacherStats[teacherKey].totalDays++\n    })\n    \n    // Calculate percentages and format data\n    const teacherList = Object.values(teacherStats).map((stats) => {\n      const total = stats.totalDays || 1 // Avoid division by zero\n      stats.percentage = Math.round((stats.present / total) * 100)\n      \n      return {\n        teacherId: stats.teacher.teacher_id || stats.teacher.id,\n        teacherName: stats.teacher.fullName,\n        subject: stats.teacher.subject || stats.teacher.subjects || stats.teacher.subject_taught || 'N/A',\n        totalDays: stats.totalDays,\n        present: stats.present,\n        absent: stats.absent,\n        late: stats.late,\n        percentage: stats.percentage,\n        dailyAttendance: stats.dailyAttendance,\n        records: stats.records,\n      }\n    })\n    \n    // Calculate general statistics\n    const totalTeachers = teacherList.length || 1\n    const totalPresent = teacherList.reduce((sum, t) => sum + t.present, 0)\n    const totalAbsent = teacherList.reduce((sum, t) => sum + t.absent, 0)\n    const totalDays = teacherList.reduce((sum, t) => sum + t.totalDays, 0)\n    const overallPresentPercentage = totalDays > 0 ? Math.round((totalPresent / totalDays) * 100) : 0\n    const overallAbsentPercentage = totalDays > 0 ? Math.round((totalAbsent / totalDays) * 100) : 0\n    \n    // Filter by specific teacher if requested\n    let selectedTeacherData = null\n    if (teacherId) {\n      selectedTeacherData = teacherList.find((t) => \n        (t.teacherId || '').toString() === teacherId.toString()\n      )\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        general: {\n          totalTeachers,\n          totalPresent,\n          totalAbsent,\n          totalDays,\n          presentPercentage: overallPresentPercentage,\n          absentPercentage: overallAbsentPercentage,\n        },\n        teachers: teacherList,\n        selectedTeacher: selectedTeacherData,\n        dateRange: {\n          start: startDateStr,\n          end: endDateStr,\n        },\n      },\n    }, { status: 200 })\n  } catch (error: any) {\n    console.error('Error in teacher attendance API:', error)\n    return NextResponse.json(\n      {\n        success: false,\n        error: error?.message || 'Internal server error',\n        data: null,\n      },\n      { status: 200 }\n    )\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}