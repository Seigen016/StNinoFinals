{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/lib/supabaseAdmin.ts"],"sourcesContent":["import { Database } from '@/database.types'\nimport { createClient, type SupabaseClient } from '@supabase/supabase-js'\n\n/**\n * Supabase Admin Client for Server-Side Operations\n * \n * ⚠️ SECURITY WARNING: This client uses the SERVICE ROLE KEY\n * - Bypasses ALL Row Level Security (RLS) policies\n * - Full database access with no restrictions\n * - ONLY use in server-side code (API routes, Server Components)\n * - NEVER import or use in client-side components\n * \n * Use Cases:\n * - Admin operations requiring elevated privileges\n * - System-level database operations\n * - Background jobs and cron tasks\n */\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n/**\n * Creates and returns a Supabase admin client instance\n * \n * @returns SupabaseClient with full admin privileges\n * @throws Error if environment variables are not set\n * \n * @example\n * ```ts\n * // In API route or Server Component only\n * const supabaseAdmin = getSupabaseAdmin();\n * const { data } = await supabaseAdmin.from('users').select('*');\n * ```\n */\nexport function getSupabaseAdmin(): SupabaseClient {\n  if (!supabaseUrl || !serviceRoleKey) {\n    throw new Error('Missing Supabase admin env. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY (server-only).')\n  }\n  \n  return createClient<Database>(supabaseUrl as string, serviceRoleKey as string, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n\n\n"],"names":[],"mappings":";;;;AACA;;AAEA;;;;;;;;;;;;;CAaC,GAED,MAAM;AACN,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;AAerD,SAAS;IACd,IAAI,CAAC,eAAe,CAAC,gBAAgB;QACnC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,mRAAY,EAAW,aAAuB,gBAA0B;QAC7E,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/app/api/admin/stats/route.ts"],"sourcesContent":["import { getSupabaseAdmin } from '@/lib/supabaseAdmin'\nimport { NextResponse } from 'next/server'\n\nexport async function GET() {\n  try {\n    const supabaseAdmin = getSupabaseAdmin()\n\n    // Fetch students count\n    const { count: studentsCount, error: studentsError } = await supabaseAdmin\n      .from('users')\n      .select('*', { count: 'exact', head: true })\n      .eq('role', 'student')\n\n    // Fetch teachers count\n    const { count: teachersCount, error: teachersError } = await supabaseAdmin\n      .from('users')\n      .select('*', { count: 'exact', head: true })\n      .eq('role', 'teacher')\n\n    // Fetch parents count\n    const { count: parentsCount, error: parentsError } = await supabaseAdmin\n      .from('users')\n      .select('*', { count: 'exact', head: true })\n      .eq('role', 'parent')\n\n    if (studentsError || teachersError || parentsError) {\n      console.error('Database error:', { studentsError, teachersError })\n      return NextResponse.json({\n        success: false,\n        error: 'Failed to fetch stats',\n        data: {\n          totalStudents: 0,\n          totalTeachers: 0,\n          totalParents: 0,\n          attendanceRate: 0,\n        },\n      }, { status: 500 })\n    }\n\n    // Calculate today's attendance rate\n    const today = new Date().toISOString().split('T')[0]\n    \n    // Get total students for attendance calculation\n    const totalStudents = studentsCount || 0\n    \n    // Get today's attendance records\n    const { data: attendanceRecords, error: attendanceError } = await supabaseAdmin\n      .from('attendance')\n      .select('student_id')\n      .gte('scanned_at', `${today}T00:00:00`)\n      .lte('scanned_at', `${today}T23:59:59`)\n\n    let attendanceRate = 0\n    if (!attendanceError && attendanceRecords && totalStudents > 0) {\n      // Count unique students who attended today\n      const uniqueStudents = new Set(attendanceRecords.map((record: any) => record.student_id))\n      attendanceRate = Math.round((uniqueStudents.size / totalStudents) * 100)\n    }\n\n    return NextResponse.json({\n      success: true,\n      data: {\n        totalStudents: studentsCount || 0,\n        totalTeachers: teachersCount || 0,\n        totalParents: parentsCount || 0,\n        attendanceRate,\n      },\n    })\n  } catch (error: any) {\n    console.error('Admin stats API error:', error)\n    return NextResponse.json(\n      {\n        success: false,\n        error: error?.message || 'Internal server error',\n        data: {\n          totalStudents: 0,\n          totalTeachers: 0,\n          totalParents: 0,\n          attendanceRate: 0,\n        },\n      },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe;IACpB,IAAI;QACF,MAAM,gBAAgB,IAAA,0IAAgB;QAEtC,uBAAuB;QACvB,MAAM,EAAE,OAAO,aAAa,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,cAC1D,IAAI,CAAC,SACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK,GACzC,EAAE,CAAC,QAAQ;QAEd,uBAAuB;QACvB,MAAM,EAAE,OAAO,aAAa,EAAE,OAAO,aAAa,EAAE,GAAG,MAAM,cAC1D,IAAI,CAAC,SACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK,GACzC,EAAE,CAAC,QAAQ;QAEd,sBAAsB;QACtB,MAAM,EAAE,OAAO,YAAY,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,cACxD,IAAI,CAAC,SACL,MAAM,CAAC,KAAK;YAAE,OAAO;YAAS,MAAM;QAAK,GACzC,EAAE,CAAC,QAAQ;QAEd,IAAI,iBAAiB,iBAAiB,cAAc;YAClD,QAAQ,KAAK,CAAC,mBAAmB;gBAAE;gBAAe;YAAc;YAChE,OAAO,+QAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,OAAO;gBACP,MAAM;oBACJ,eAAe;oBACf,eAAe;oBACf,cAAc;oBACd,gBAAgB;gBAClB;YACF,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,oCAAoC;QACpC,MAAM,QAAQ,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,IAAI,CAAC,EAAE;QAEpD,gDAAgD;QAChD,MAAM,gBAAgB,iBAAiB;QAEvC,iCAAiC;QACjC,MAAM,EAAE,MAAM,iBAAiB,EAAE,OAAO,eAAe,EAAE,GAAG,MAAM,cAC/D,IAAI,CAAC,cACL,MAAM,CAAC,cACP,GAAG,CAAC,cAAc,GAAG,MAAM,SAAS,CAAC,EACrC,GAAG,CAAC,cAAc,GAAG,MAAM,SAAS,CAAC;QAExC,IAAI,iBAAiB;QACrB,IAAI,CAAC,mBAAmB,qBAAqB,gBAAgB,GAAG;YAC9D,2CAA2C;YAC3C,MAAM,iBAAiB,IAAI,IAAI,kBAAkB,GAAG,CAAC,CAAC,SAAgB,OAAO,UAAU;YACvF,iBAAiB,KAAK,KAAK,CAAC,AAAC,eAAe,IAAI,GAAG,gBAAiB;QACtE;QAEA,OAAO,+QAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,MAAM;gBACJ,eAAe,iBAAiB;gBAChC,eAAe,iBAAiB;gBAChC,cAAc,gBAAgB;gBAC9B;YACF;QACF;IACF,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,+QAAY,CAAC,IAAI,CACtB;YACE,SAAS;YACT,OAAO,OAAO,WAAW;YACzB,MAAM;gBACJ,eAAe;gBACf,eAAe;gBACf,cAAc;gBACd,gBAAgB;YAClB;QACF,GACA;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}