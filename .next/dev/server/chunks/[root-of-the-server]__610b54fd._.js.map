{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 76, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/lib/supabaseAdmin.ts"],"sourcesContent":["import { Database } from '@/database.types'\nimport { createClient, type SupabaseClient } from '@supabase/supabase-js'\n\n/**\n * Supabase Admin Client for Server-Side Operations\n * \n * ⚠️ SECURITY WARNING: This client uses the SERVICE ROLE KEY\n * - Bypasses ALL Row Level Security (RLS) policies\n * - Full database access with no restrictions\n * - ONLY use in server-side code (API routes, Server Components)\n * - NEVER import or use in client-side components\n * \n * Use Cases:\n * - Admin operations requiring elevated privileges\n * - System-level database operations\n * - Background jobs and cron tasks\n */\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\nconst serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n/**\n * Creates and returns a Supabase admin client instance\n * \n * @returns SupabaseClient with full admin privileges\n * @throws Error if environment variables are not set\n * \n * @example\n * ```ts\n * // In API route or Server Component only\n * const supabaseAdmin = getSupabaseAdmin();\n * const { data } = await supabaseAdmin.from('users').select('*');\n * ```\n */\nexport function getSupabaseAdmin(): SupabaseClient {\n  if (!supabaseUrl || !serviceRoleKey) {\n    throw new Error('Missing Supabase admin env. Set NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY (server-only).')\n  }\n  \n  return createClient<Database>(supabaseUrl as string, serviceRoleKey as string, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false,\n    },\n  })\n}\n\n\n"],"names":[],"mappings":";;;;AACA;;AAEA;;;;;;;;;;;;;CAaC,GAED,MAAM;AACN,MAAM,iBAAiB,QAAQ,GAAG,CAAC,yBAAyB;AAerD,SAAS;IACd,IAAI,CAAC,eAAe,CAAC,gBAAgB;QACnC,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAA,mRAAY,EAAW,aAAuB,gBAA0B;QAC7E,MAAM;YACJ,kBAAkB;YAClB,gBAAgB;QAClB;IACF;AACF"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///Users/koyaemer/Development/StNinoFinals/app/api/students/update-rfid/route.ts"],"sourcesContent":["import { getSupabaseAdmin } from '@/lib/supabaseAdmin'\nimport { NextResponse } from 'next/server'\n\nexport async function POST(request: Request) {\n  try {\n    const updateData = await request.json()\n\n    // Validate required fields\n    if (!updateData.email && !updateData.studentId) {\n      return NextResponse.json(\n        { success: false, error: 'Email or Student ID is required' },\n        { status: 400 }\n      )\n    }\n\n    if (!updateData.rfidCard) {\n      return NextResponse.json(\n        { success: false, error: 'RFID Card number is required' },\n        { status: 400 }\n      )\n    }\n\n    const admin = getSupabaseAdmin()\n\n    if (!admin) {\n      console.error('Supabase admin client not initialized')\n      if (process.env.NODE_ENV === 'development') {\n        return NextResponse.json({\n          success: true,\n          message: 'RFID updated (dev mode - not saved to database)',\n        })\n      }\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Database service not configured. Please check your environment variables.' \n        },\n        { status: 500 }\n      )\n    }\n\n    // Build query to find student\n    let students: any[] = []\n    let findError: any = null\n    \n    if (updateData.email) {\n      // Find by email\n      const { data, error } = await admin\n        .from('users')\n        .select('*')\n        .eq('role', 'student')\n        .eq('email', updateData.email.toLowerCase().trim())\n        .limit(10)\n      students = data || []\n      findError = error\n    } else if (updateData.studentId) {\n      // Find by student ID - get all and filter in memory to avoid column errors\n      const { data: allStudents, error } = await admin\n        .from('users')\n        .select('*')\n        .eq('role', 'student')\n        .limit(1000)\n      \n      if (!error && allStudents) {\n        students = allStudents.filter((s: any) => {\n          const num1 = (s.student_number || '').toString()\n          const id = (s.id || '').toString()\n          const searchId = updateData.studentId.toString()\n          return num1 === searchId || id === searchId\n        })\n      } else {\n        findError = error\n      }\n    }\n\n    if (findError) {\n      console.error('Database error finding student:', findError)\n      return NextResponse.json(\n        { success: false, error: findError.message },\n        { status: 500 }\n      )\n    }\n\n    if (!students || students.length === 0) {\n      return NextResponse.json(\n        { success: false, error: 'Student not found' },\n        { status: 404 }\n      )\n    }\n\n    const student = students[0]\n\n    // Update student with RFID card number\n    const updateFields: any = {\n      rfid: updateData.rfidCard  // Single rfid column in new schema\n    }\n\n    console.log('Updating student with RFID:', updateData.rfidCard)\n    console.log('Student ID:', student.id)\n    console.log('Student email:', student.email)\n\n    const { data: updatedStudent, error: updateError } = await admin\n      .from('users')\n      .update(updateFields)\n      .eq('id', student.id)\n      .select()\n      .single()\n\n    if (updateError) {\n      console.error('Database error updating RFID:', updateError)\n      console.error('Error message:', updateError.message)\n      \n      // Check if error is about missing column\n      if (updateError.message && (\n        (updateError.message.includes('column') && updateError.message.includes('does not exist')) ||\n        updateError.message.includes('rfid')\n      )) {\n        return NextResponse.json(\n          { \n            success: false, \n            error: `RFID column not found in database. Please add an 'rfid' column to your 'users' table in Supabase.`,\n            hint: 'Run this SQL in Supabase: ALTER TABLE users ADD COLUMN rfid TEXT;'\n          },\n          { status: 500 }\n        )\n      }\n      \n      // Other database errors\n      return NextResponse.json(\n        { \n          success: false, \n          error: `Failed to update RFID: ${updateError.message}`,\n          details: 'Please check your database connection and permissions.'\n        },\n        { status: 500 }\n      )\n    }\n\n    // Remove password from response\n    const studentWithoutPassword = { ...updatedStudent }\n    if (studentWithoutPassword.Password !== undefined) {\n      delete studentWithoutPassword.Password\n    }\n    if (studentWithoutPassword.password !== undefined) {\n      delete studentWithoutPassword.password\n    }\n\n    return NextResponse.json({\n      success: true,\n      student: studentWithoutPassword,\n      message: 'RFID card number updated successfully',\n    })\n  } catch (error: any) {\n    console.error('Update RFID API error:', error)\n    return NextResponse.json(\n      {\n        success: false,\n        error: error?.message || 'Internal server error',\n      },\n      { status: 500 }\n    )\n  }\n}\n\n"],"names":[],"mappings":"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"}}]
}