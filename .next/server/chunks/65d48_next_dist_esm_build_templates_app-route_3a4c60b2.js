module.exports=[63061,e=>{"use strict";var t=e.i(69504),r=e.i(58047),n=e.i(65185),o=e.i(24876),s=e.i(28628),a=e.i(42863),i=e.i(25100),l=e.i(58332),c=e.i(3422),d=e.i(97859),u=e.i(71382),m=e.i(19874),p=e.i(70460),g=e.i(93358),h=e.i(52502),f=e.i(63744),_=e.i(93695);e.i(99159);var S=e.i(16904);async function E(e,t){if(!e)return console.warn("sendSms called without phone number"),!1;let r=process.env.TEXTBEE_API_KEY,n=process.env.TEXTBEE_API_URL||"https://api.textbee.com/v1",o=process.env.TEXTBEE_SENDER_ID||process.env.TEXTBEE_SENDER||process.env.SMS_SENDER||null;if(!r)return console.warn("TEXTBEE_API_KEY is not configured; skipping SMS send"),!1;try{let s=`${n.replace(/\/+$/,"")}/messages`,a={to:e,message:t};o&&(a.from=o);let i=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(a)});if(!i.ok){let e=await i.text();return console.error("TextBee API error:",i.status,e),!1}try{let e=await i.json();console.log("TextBee sent msg, id:",e?.id||"unknown")}catch(e){}return!0}catch(e){return console.error("Failed to send SMS using TextBee:",e?.message||e),!1}}var T=e.i(44687),y=e.i(10027);let w=new Map;async function C(e){return new y.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}async function A(e){let t={"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"};try{let r,n=new URL(e.url);console.log("=== GET REQUEST DEBUG ==="),console.log("Request URL:",n.toString()),console.log("Origin:",e.headers.get("origin")||"N/A"),console.log("Host:",e.headers.get("host")||"N/A"),console.log("Environment:","production"),console.log("=========================");let{searchParams:o}=new URL(e.url),s=parseInt(o.get("limit")||"50"),a=o.get("since");try{r=(0,T.getSupabaseAdmin)()}catch(e){return console.error("Failed to get Supabase admin client:",e),y.NextResponse.json({success:!0,records:[],warning:"Database client initialization failed",error:void 0},{status:200,headers:t})}if(!r)return y.NextResponse.json({success:!0,records:[],warning:"Database client not available"},{status:200,headers:t});let i=[],l=null;try{console.log("Attempting to fetch attendance records..."),console.log("Limit:",s),console.log("Since:",a);let e=!1;try{console.log("Method 1: Trying RPC function...");let{data:t,error:n}=await r.rpc("get_attendance_records",{record_limit:s,since_time:a||null});!n&&t?(i=t,l=null,e=!0,console.log("âœ“ RPC query successful, records:",(i||[]).length)):console.log("âœ— RPC failed:",n?.message||"RPC function not found")}catch(e){console.log("âœ— RPC exception:",e.message)}if(!e)try{console.log("Method 2: Trying direct query with explicit columns...");let t=r.from("attendance_records").select("id, scan_time, scan_type, student_id, rfid_card, rfid_tag, status, time_in, time_out, created_at, device_id").order("scan_time",{ascending:!1}).limit(s);a&&(t=t.gt("scan_time",a));let n=await t;if(!n.error&&n.data)i=n.data||[],l=null,e=!0,console.log("âœ“ Direct query (minimal) successful, records:",(i||[]).length);else if(n.error?.code==="PGRST200"||n.error?.message?.includes("relationship")||n.error?.message?.includes("Could not find a relationship"))console.log("âš  PostgREST relationship error - returning empty records (this is OK)"),i=[],l=null,e=!0;else throw n.error}catch(t){"PGRST200"===t.code||t.message?.includes("relationship")||t.message?.includes("Could not find a relationship")?console.log("âš  PostgREST relationship error in catch - returning empty records"):console.error("âœ— Direct query failed:",t),i=[],l=null,e=!0}e||(console.log("âš  All query methods failed - returning empty records"),i=[],l=null)}catch(e){console.error("Query execution exception:",e),console.error("Exception name:",e.name),console.error("Exception message:",e.message),console.error("Exception stack:",e.stack),l=e}if(l)return console.error("Database error:",l),console.error("Error code:",l.code),console.error("Error message:",l.message),console.error("Error details:",l.details),console.error("Error hint:",l.hint),y.NextResponse.json({success:!0,records:[],warning:"Unable to fetch attendance records from database",error:void 0,details:void 0},{status:200,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}});let c=[...new Set((i||[]).map(e=>e.student_id).filter(Boolean))],d={},u={};if(c.length>0)try{let{data:e,error:t}=await r.from("students").select("*").limit(1e3);!t&&e&&e.forEach(e=>{let t=(e.student_id||"").toString().trim(),r=(e.student_number||"").toString().trim(),n=(e.id||"").toString().trim();t&&(d[t]=e),r&&(d[r]=e),n&&(d[n]=e)});let{data:n,error:o}=await r.from("teachers").select("*").limit(1e3);!o&&n&&n.forEach(e=>{let t=(e.teacher_id||e.id||"").toString().trim(),r=(e.email||"").toString().trim().toLowerCase();t&&(u[t]=e),r&&(u[r]=e)})}catch(e){console.error("Error fetching students/teachers:",e)}if(!i||!Array.isArray(i)||0===i.length)return console.log("ðŸ“­ No attendance records found in database"),console.log("ðŸ’¡ This could mean:"),console.log("   1. No scans have been recorded yet"),console.log("   2. Database table is empty"),console.log("   3. ESP32 scans are not being saved (check POST endpoint logs)"),y.NextResponse.json({success:!0,records:[],message:"No attendance records found. Scans will appear here once recorded."},{status:200,headers:t});console.log(`âœ… Found ${(i||[]).length} attendance records`),(i||[]).length>0&&console.log("ðŸ“… Sample record times:",i.slice(0,3).map(e=>({scan_time:e.scan_time,created_at:e.created_at,id:e.id})));let m=(i||[]).map(e=>{let t=null;e.time_in&&e.scan_time===e.time_in?t="timein":e.time_out&&e.scan_time===e.time_out?t="timeout":e.scan_type?t="time_in"===e.scan_type.toLowerCase()||"timein"===e.scan_type.toLowerCase()?"timein":"time_out"===e.scan_type.toLowerCase()||"timeout"===e.scan_type.toLowerCase()?"timeout":null:e.type&&(t="time_in"===e.type.toLowerCase()||"timein"===e.type.toLowerCase()?"timein":"time_out"===e.type.toLowerCase()||"timeout"===e.type.toLowerCase()?"timeout":null);let r=d[e.student_id]||null,n=u[e.student_id]||null,o=!!n||r&&("teacher"===r.role||"teacher"===r.user_type||r.teacher_id||!r.student_id&&!r.student_number),s=n||r;return{id:e.id,studentId:e.student_id,studentName:s&&(`${s.first_name||s.firstName||""} ${s.last_name||s.lastName||""}`.trim()||s.name)||"Unknown",gradeLevel:o?null:s?.grade_level||s?.gradeLevel||"N/A",section:o?null:s?.section||"N/A",scanTime:e.scan_time||e.created_at,status:e.status||"Present",rfidCard:e.rfid_card||"N/A",studentPhoto:s?.photo_url||s?.profile_picture||s?.picture||null,scanType:t,timeIn:e.time_in||null,timeOut:e.time_out||null,isTeacher:o||!1,subject:o?s?.subject||s?.subjects||s?.subject_taught||"N/A":null,role:s?.role||null}});return console.log(`ðŸ“¤ Returning ${(m||[]).length} formatted records to frontend`),(m||[]).length>0&&(console.log("ðŸ“… First record scan time:",m[0]?.scanTime),console.log("ðŸ“… Last record scan time:",m[m.length-1]?.scanTime)),y.NextResponse.json({success:!0,records:m,count:m.length},{status:200,headers:t})}catch(e){console.error("Attendance records API error:",e),console.error("Error stack:",e?.stack),console.error("Error name:",e?.name),console.error("Error message:",e?.message);try{return y.NextResponse.json({success:!0,records:[],warning:"Unable to fetch attendance records",error:e?.message||"Internal server error",details:void 0},{status:200,headers:t})}catch(e){return console.error("Failed to create JSON response:",e),new y.NextResponse(JSON.stringify({success:!0,records:[],warning:"Service temporarily unavailable"}),{status:200,headers:t})}}}async function R(e){let t={"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"};try{console.log("=== POST: ENVIRONMENT VARIABLES DEBUG ==="),console.log("URL:","SET"),console.log("URL Value:","https://ulntyefamkxkbynrugop.supabase.co"),console.log("ANON:","SET"),console.log("ANON Key (first 20 chars):","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVsbnR5ZWZhbWt4a2J5bnJ1Z29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjgwNDEsImV4cCI6MjA3NjIwNDA0MX0.TnL8jfBVJD8Z0N5rFl_KFhAku8zxiy2fFvztBDYHaWk".substring(0,20)||"MISSING"),console.log("SERVICE:",process.env.SUPABASE_SERVICE_ROLE_KEY?"SET":"MISSING"),console.log("SERVICE Key (first 20 chars):",process.env.SUPABASE_SERVICE_ROLE_KEY?.substring(0,20)||"MISSING"),console.log("==========================================");let r=null;try{r=await e.json()}catch(e){return console.error("Error parsing request JSON:",e),y.NextResponse.json({success:!1,error:"Invalid JSON in request body",message:"Please ensure the request contains valid JSON"},{status:200,headers:t})}if(!r)return y.NextResponse.json({success:!1,error:"Request body is required",message:"Please include RFID card data in the request"},{status:200,headers:t});if(!r.studentId&&!r.rfidCard)return y.NextResponse.json({success:!1,error:"Student ID or RFID Card is required",records:[]},{status:200,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}});let n=(0,T.getSupabaseAdmin)();if(!n)return console.error("Supabase client not initialized"),y.NextResponse.json({success:!1,error:"Database service not configured. Please check your environment variables.",records:[]},{status:200,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}});let o=new Date;o.setHours(0,0,0,0);let s=o.toISOString(),a=new Date(o);a.setHours(23,59,59,999);let i=a.toISOString(),l=r.studentId;if(!l&&r.rfidCard){let e=r.rfidCard.toString().trim().toUpperCase().replace(/\s+/g,""),t=e.replace(/^0+/,"");console.log(`Searching for student with RFID: ${e} (also trying: ${t})`);let{data:o,error:s}=await n.from("students").select("*").limit(1e3);if(s)return console.error("Error fetching students:",s),y.NextResponse.json({success:!1,error:`Database error: ${s.message}`,searchedRfid:e,records:[]},{status:200,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}});console.log(`Checking teachers first for RFID: ${e}`);let{data:a,error:i}=await n.from("teachers").select("*").limit(1e3),c=null;if(!i&&a){let r=(a||[]).filter(r=>{let n=(r.rfid_card||"").toString().trim().toUpperCase(),o=(r.rfidCard||"").toString().trim().toUpperCase(),s=(r.rfid_tag||"").toString().trim().toUpperCase(),a=(r.rfidTag||"").toString().trim().toUpperCase();return n===e||n===t||o===e||o===t||s===e||s===t||a===e||a===t||n.includes(e)||o.includes(e)||s.includes(e)||a.includes(e)});r&&r.length>0&&(c=r[0],console.log(`âœ… Found teacher FIRST: ${c.first_name||c.firstName||"Unknown"} ${c.last_name||c.lastName||""}`),l=c.teacher_id||c.id?.toString()||c.email)}if(!c){console.log(`No teacher found, checking students for RFID: ${e}`);let r=(o||[]).filter(r=>{let n=(r.rfid_card||"").toString().trim().toUpperCase(),o=(r.rfidCard||"").toString().trim().toUpperCase(),s=(r.rfid_tag||"").toString().trim().toUpperCase(),a=(r.rfidTag||"").toString().trim().toUpperCase();return n===e||n===t||o===e||o===t||s===e||s===t||a===e||a===t||n.includes(e)||o.includes(e)||s.includes(e)||a.includes(e)});if(!r||0===r.length)return console.log(`âŒ No student or teacher found with RFID: ${e}`),y.NextResponse.json({success:!1,error:`No student or teacher found for RFID: ${e}. Please assign this RFID card in the admin panel.`,searchedRfid:e,message:`RFID ${e} not assigned to any student or teacher`},{status:404,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}});{let e=r[0];console.log(`Found student: ${e.first_name||e.firstName||"Unknown"} ${e.last_name||e.lastName||""}`),l=e.student_number||e.student_id||e.studentId||e.id?.toString()}}}let c=[],d=null,{data:u,error:m}=await n.from("attendance_records").select("id, scan_type, scan_time, time_in, time_out, student_id").gte("scan_time",s).lte("scan_time",i).order("scan_time",{ascending:!0});m?(d=m,console.error("Error fetching today records:",m)):u&&(c=u.filter(e=>{let t=(e.student_id||"").toString().trim(),r=(l||"").toString().trim();return t===r||t===l||r===e.student_id})),d&&console.error("Error checking existing records:",d);let p=c.some(e=>"timein"===e.scan_type||"time_in"===e.scan_type||e.time_in),g=c.some(e=>"timeout"===e.scan_type||"time_out"===e.scan_type||e.time_out);if(p&&g)return console.log("âš ï¸ Student has already timed in and out today"),y.NextResponse.json({success:!1,message:"You have completed your attendance for today.",error:"Already completed attendance for today",hasTimeIn:!0,hasTimeOut:!0},{status:200,headers:t});let h=new Date().toISOString(),f="timein",_=null,S=null,C=function(){let e=Date.now();for(let[t,r]of w.entries())e>r&&w.delete(t);let t=Date.now();for(let e of w.values())if(t<e)return!0;return!1}();if(p&&!g){f="timeout",S=h;let e=c.filter(e=>"timein"===e.scan_type||"time_in"===e.scan_type).sort((e,t)=>new Date(t.scan_time).getTime()-new Date(e.scan_time).getTime())[0];e&&(_=e.time_in||e.scan_time),console.log("â° Student already timed in today - forcing timeout")}else if(C&&!p)f="timein",_=h,console.log("âš ï¸ Timeout mode active but no time in yet - recording as time in");else if(C&&p){f="timeout",S=h;let e=c.filter(e=>"timein"===e.scan_type||"time_in"===e.scan_type).sort((e,t)=>new Date(t.scan_time).getTime()-new Date(e.scan_time).getTime())[0];e&&(_=e.time_in||e.scan_time),console.log("â° Timeout mode active with existing time in - recording as timeout")}else f="timein",_=h,console.log("âœ… Recording as time in (default)");let A={student_id:l},R=r.rfidCard||"";R?(A.rfid_card=R,A.rfid_tag=R):(A.rfid_card="",A.rfid_tag=""),A.scan_time=h,A.scan_type=f,A.time_in=_,A.time_out=S,A.status="Present",A.created_at=h,A.type=f,console.log("ðŸ’¾ Inserting attendance record:",{student_id:A.student_id,rfid_card:A.rfid_card,scan_type:A.scan_type,scan_time:A.scan_time});let{data:N,error:v}=await n.from("attendance_records").insert([A]).select("*").single();if(v)return console.error("âŒ Insert failed:",v),console.error("Database error:",v),y.NextResponse.json({success:!1,error:v.message,hint:"Please check that all required columns exist in attendance_records table. Run create-attendance-table.sql in Supabase.",records:[]},{status:200,headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"}});let O=null,I=!1;if(l){let{data:e}=await n.from("students").select("*").limit(1e3);if(e){let t=(l||"").toString().trim();O=e.find(e=>{let r=(e.student_id||"").toString().trim(),n=(e.student_number||"").toString().trim(),o=(e.id||"").toString().trim();return r===t||n===t||o===t})||null}if(!O){let{data:e}=await n.from("teachers").select("*").limit(1e3);if(e){let t=(l||"").toString().trim();(O=e.find(e=>{let r=(e.teacher_id||"").toString().trim(),n=(e.id||"").toString().trim(),o=(e.email||"").toString().trim().toLowerCase();return r===t||n===t||o===t})||null)&&(I=!0)}}}let b={id:N.id,studentId:N.student_id||l,studentName:O&&(`${O.first_name||O.firstName||""} ${O.last_name||O.lastName||""}`.trim()||O.name)||"Unknown",gradeLevel:I?null:O?.grade_level||O?.gradeLevel||"N/A",section:I?null:O?.section||"N/A",scanTime:N.scan_time||N.created_at,status:N.status||"Present",rfidCard:N.rfid_card||r.rfidCard||"N/A",studentPhoto:O?.photo_url||O?.profile_picture||O?.picture||null,scanType:f,timeIn:N.time_in||null,timeOut:N.time_out||null,isTeacher:I,subject:I?O?.subject||O?.subjects||O?.subject_taught||"N/A":null};console.log("âœ… Scan saved successfully!",{id:N.id,student:b.studentName,scanType:f,scanTime:b.scanTime});try{if(!I&&"timein"===f){let e=null;try{let t=[],r=O?.parent_id||O?.parentId||null;if(r){let{data:e,error:o}=await n.from("parents").select("id, phone, mobile, phone_number, email").eq("id",r).limit(1).single();!o&&e&&t.push(e)}let o=O?.parent_email||O?.parentEmail||null;if(!t.length&&o){let{data:e,error:r}=await n.from("parents").select("id, phone, mobile, phone_number, email").ilike("email",o).limit(1).single();!r&&e&&t.push(e)}if(!t.length&&(O?.student_id||O?.student_number||O?.id)){let e=O?.student_id||O?.student_number||O?.id;try{let{data:r}=await n.from("parent_students").select("parent_id").eq("student_id",e).limit(10);if(r&&r.length>0){let e=r.map(e=>e.parent_id).filter(Boolean);if(e.length>0){let{data:r}=await n.from("parents").select("id, phone, mobile, phone_number, email").in("id",e);r&&t.push(...r)}}}catch(e){}}if(t&&t.length>0){let r=t[0];e=r?.phone||r?.mobile||r?.phone_number||null}}catch(e){console.warn("Unable to query parents table for phone number:",e)}if(!e&&O)for(let t of["parent_phone","parentPhone","parent_contact","parentContact","parent_mobile","parentMobile","phone","emergency_contact","emergencyContact"]){let r=O[t];if(r){e=r;break}}if(e){let t=(process.env.SMS_ON_SCAN_ENABLED||"false").toLowerCase();if("true"!==t&&"1"!==t)console.log("SMS notifications are disabled (SMS_ON_SCAN_ENABLED is not set to true)");else{let t=e.toString().trim();if(!t.startsWith("+")){let e=process.env.DEFAULT_PHONE_COUNTRY_CODE||"";e&&(t=`${e}${t}`)}let r=(process.env.SMS_ON_SCAN_TEMPLATE||"Dear parent, {studentName} ({gradeLevel} - {section}) was recorded present at {scanTime}. â€” Sto NiÃ±o Portal").replace("{studentName}",b.studentName).replace("{gradeLevel}",b.gradeLevel||"N/A").replace("{section}",b.section||"N/A").replace("{scanTime}",b.scanTime||new Date().toISOString()),n=await E(t,r);console.log("SMS notify result:",n)}}else console.log("No parent phone found for student, skipping SMS")}}catch(e){console.error("SMS notification error:",e)}return y.NextResponse.json({success:!0,record:b,message:`Time ${"timein"===f?"In":"Out"} recorded successfully`},{status:200,headers:t})}catch(e){return console.error("CRITICAL: Unhandled error in POST handler:",e),console.error("Error stack:",e?.stack),console.error("Error name:",e?.name),console.error("Error message:",e?.message),y.NextResponse.json({success:!1,error:"Internal server error",records:[],warning:"Service error occurred"},{status:200,headers:t})}}async function N(e){let t={"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, OPTIONS","Access-Control-Allow-Headers":"Content-Type"};try{let{action:r}=await e.json();if("enable-timeout"!==r)return y.NextResponse.json({success:!1,error:"Invalid action"},{status:400,headers:t});{let e=Date.now(),r=e+5e3;return w.set(e,r),console.log("â° Timeout mode enabled for 5 seconds"),y.NextResponse.json({success:!0,message:"Timeout mode enabled for 5 seconds",expiresAt:r},{status:200,headers:t})}}catch(e){return console.error("Error in PUT handler:",e),y.NextResponse.json({success:!1,error:e?.message||"Internal server error"},{status:200,headers:t})}}e.s(["GET",()=>A,"OPTIONS",()=>C,"POST",()=>R,"PUT",()=>N],97408);var v=e.i(97408);let O=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/admin/attendance-live/route",pathname:"/api/admin/attendance-live",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/admin/attendance-live/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:I,workUnitAsyncStorage:b,serverHooks:P}=O;function x(){return(0,n.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:b})}async function D(e,t,n){O.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/admin/attendance-live/route";E=E.replace(/\/index$/,"")||"/";let T=await O.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!T)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:y,params:w,nextConfig:C,parsedUrl:A,isDraftMode:R,prerenderManifest:N,routerServerContext:v,isOnDemandRevalidate:I,revalidateOnlyGenerated:b,resolvedPathname:P,clientReferenceManifest:x,serverActionsManifest:D}=T,j=(0,l.normalizeAppPath)(E),U=!!(N.dynamicRoutes[j]||N.routes[P]),M=async()=>((null==v?void 0:v.render404)?await v.render404(e,t,A,!1):t.end("This page could not be found"),null);if(U&&!R){let e=!!N.routes[P],t=N.dynamicRoutes[j];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await M();throw new _.NoFallbackError}}let k=null;!U||O.isDev||R||(k="/index"===(k=P)?"/":k);let L=!0===O.isDev||!U,q=U&&!L;D&&x&&(0,a.setReferenceManifestsSingleton)({page:E,clientReferenceManifest:x,serverActionsManifest:D,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:D})});let $=e.method||"GET",H=(0,s.getTracer)(),F=H.getActiveScopeSpan(),B={params:w,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>O.onRequestError(e,t,n,v)},sharedContext:{buildId:y}},G=new c.NodeNextRequest(e),J=new c.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest(G,(0,d.signalFromNodeResponse)(t));try{let a=async e=>O.handle(K,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=H.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${E}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var s,l;let c=async({previousCacheEntry:r})=>{try{if(!i&&I&&b&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await a(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let c=B.renderOpts.collectedTags;if(!U)return await (0,p.sendResponse)(G,J,s,B.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(s.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:S.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:I})},v),t}},d=await O.handleResponse({req:e,nextConfig:C,cacheKey:k,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:b,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:i});if(!U)return null;if((null==d||null==(s=d.value)?void 0:s.kind)!==S.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",I?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),R&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&U||u.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,h.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(G,J,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};F?await l(F):await H.withPropagatedContext(e.headers,()=>H.trace(u.BaseServerSpan.handleRequest,{spanName:`${$} ${E}`,kind:s.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof _.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:j,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:I})}),U)throw t;return await (0,p.sendResponse)(G,J,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>x,"routeModule",()=>O,"serverHooks",()=>P,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>b],63061)}];

//# sourceMappingURL=65d48_next_dist_esm_build_templates_app-route_3a4c60b2.js.map